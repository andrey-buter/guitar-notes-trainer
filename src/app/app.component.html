<div class="app-container">
  <!-- –ó–∞–≥–æ–ª–æ–≤–æ–∫ -->
  <header class="app-header">
    <div class="header-content">
      <div class="header-main">
        <h1>{{ 'APP.TITLE' | translate }}</h1>
        <div class="song-title" *ngIf="songTitle">{{ songTitle }}</div>
        <!-- Language switcher -->
        <div class="language-switcher">
          <button
            class="lang-btn"
            [class.active]="getCurrentLanguage() === 'en'"
            (click)="switchLanguage('en')"
            title="English">
            EN
          </button>
          <button
            class="lang-btn"
            [class.active]="getCurrentLanguage() === 'ru'"
            (click)="switchLanguage('ru')"
            title="–†—É—Å—Å–∫–∏–π">
            RU
          </button>
        </div>
      </div>

      <!-- Tabs for display mode switching -->
      <div class="header-tabs">
        <button
          class="tab-btn"
          [class.active]="getCurrentNoteNamesTarget() === 'none'"
          (click)="setNoteNamesTarget('none')">
          {{ 'TABS.DEFAULT' | translate }}
        </button>
        <button
          class="tab-btn"
          [class.active]="getCurrentNoteNamesTarget() === 'tab-numbers'"
          (click)="setNoteNamesTarget('tab-numbers')">
          {{ 'TABS.NOTE_NAMES' | translate }}
        </button>
        <button
          class="tab-btn"
          [class.active]="getCurrentNoteNamesTarget() === 'tab-numbers-octave'"
          (click)="setNoteNamesTarget('tab-numbers-octave')">
          {{ 'TABS.NOTE_NAMES_OCTAVE' | translate }}
        </button>
        <button
          class="tab-btn"
          [class.active]="getCurrentNoteNamesTarget() === 'scale-degrees'"
          (click)="setNoteNamesTarget('scale-degrees')">
          {{ 'TABS.FRETBOARD_DEGREES' | translate }}
        </button>
        <button
          class="tab-btn"
          [class.active]="getCurrentNoteNamesTarget() === 'scale-degrees-roman'"
          (click)="setNoteNamesTarget('scale-degrees-roman')">
          {{ 'TABS.ROMAN_NUMERALS' | translate }}
        </button>
      </div>

      <div class="music-info" *ngIf="keyInfo || tuningInfo">
        <div class="info-item" *ngIf="keyInfo">
          <span class="info-label">{{ 'HEADER.KEY' | translate }}</span>
          <span class="info-value key-badge">
            {{ getCurrentLanguage() === 'ru' ? keyInfo.keyNameRu : keyInfo.keyName }}
            <span class="confidence" [title]="'–£–≤–µ—Ä–µ–Ω–Ω–æ—Å—Ç—å: ' + (keyInfo.confidence * 100).toFixed(0) + '%'">
              ({{ (keyInfo.confidence * 100).toFixed(0) }}%)
            </span>
          </span>
        </div>
        <div class="info-item" *ngIf="tuningInfo">
          <span class="info-label">{{ 'HEADER.TUNING' | translate }}:</span>
          <span class="info-value tuning-badge">
            {{ tuningInfo.tuningName }}
            <span class="tuning-notes">[{{ getFormattedTuning() }}]</span>
          </span>
        </div>

        <!-- –ö–Ω–æ–ø–∫–∞ –¥–ª—è –æ—Ç–∫—Ä—ã—Ç–∏—è –ø–∞–Ω–µ–ª–∏ –¥–æ—Ä–æ–∂–µ–∫ -->
        <div class="info-item" *ngIf="tracks.length > 1">
          <button class="tracks-toggle-btn"
                  [class.active]="showTracksPanel"
                  (click)="toggleTracksPanel()"
                  [title]="'HEADER.TRACKS' | translate">
            üé∏ {{ 'HEADER.TRACKS' | translate }} ({{ tracks.length }})
          </button>
        </div>

        <!-- –ö–Ω–æ–ø–∫–∞ –¥–ª—è –æ—Ç–∫—Ä—ã—Ç–∏—è –ø–∞–º—è—Ç–∫–∏ –æ–∫—Ç–∞–≤ -->
        <div class="info-item">
          <button class="octaves-toggle-btn"
                  [class.active]="showFretboardOctaves"
                  (click)="toggleFretboardOctaves()"
                  [title]="getCurrentLanguage() === 'ru' ? '–û–∫—Ç–∞–≤—ã –Ω–∞ –≥—Ä–∏—Ñ–µ' : 'Fretboard Octaves'">
            üéµ {{ getCurrentLanguage() === 'ru' ? '–û–∫—Ç–∞–≤—ã' : 'Octaves' }}
          </button>
        </div>
      </div>

      <!-- –û–≤–µ—Ä–ª–µ–π —Å –∑–∞—Ç–µ–º–Ω–µ–Ω–∏–µ–º -->
      <div class="tracks-backdrop"
           *ngIf="showTracksPanel || showFretboardOctaves"
           (click)="showTracksPanel ? toggleTracksPanel() : toggleFretboardOctaves()"></div>

      <!-- –ü–∞–Ω–µ–ª—å –≤—ã–±–æ—Ä–∞ –¥–æ—Ä–æ–∂–µ–∫ -->
      <div class="tracks-panel" *ngIf="showTracksPanel && tracks.length > 0">
        <div class="tracks-panel-header">
          <span class="tracks-panel-title">{{ 'HEADER.TRACKS' | translate }}</span>
          <button class="tracks-panel-close" (click)="toggleTracksPanel()">‚úï</button>
        </div>
        <div class="tracks-list">
          <div class="track-item"
               *ngFor="let track of tracks"
               [class.track-visible]="track.isVisible"
               [class.track-muted]="track.isMuted"
               [class.track-solo]="track.isSolo">
            <div class="track-info">
              <input type="checkbox"
                     class="track-visibility-check"
                     [checked]="track.isVisible"
                     (change)="toggleTrackVisibility(track.index)"
                     [id]="'track-' + track.index">
              <label [for]="'track-' + track.index" class="track-name">
                <span class="track-number">{{ track.index + 1 }}.</span>
                {{ track.name }}
                <span class="track-instrument">({{ track.instrument }})</span>
              </label>
            </div>
            <div class="track-controls">
              <button class="track-control-btn mute-btn"
                      [class.active]="track.isMuted"
                      (click)="toggleTrackMute(track.index)"
                      title="{{ track.isMuted ? 'Unmute' : 'Mute' }}">
                üîá
              </button>
              <button class="track-control-btn solo-btn"
                      [class.active]="track.isSolo"
                      (click)="toggleTrackSolo(track.index)"
                      title="{{ track.isSolo ? 'Unsolo' : 'Solo' }}">
                üîä
              </button>
            </div>
          </div>
        </div>
      </div>

      <!-- –ü–∞–º—è—Ç–∫–∞ –æ–∫—Ç–∞–≤ –Ω–∞ –≥—Ä–∏—Ñ–µ -->
      <div class="fretboard-octaves-panel" *ngIf="showFretboardOctaves">
        <div class="fretboard-panel-header">
          <span class="fretboard-panel-title">
            {{ getCurrentLanguage() === 'ru' ? '–û–∫—Ç–∞–≤—ã –Ω–∞ –≥–∏—Ç–∞—Ä–Ω–æ–º –≥—Ä–∏—Ñ–µ' : 'Guitar Fretboard Octaves' }}
          </span>
          <button class="fretboard-panel-close" (click)="toggleFretboardOctaves()">‚úï</button>
        </div>

        <div class="fretboard-legend">
          <div class="legend-item" *ngFor="let octave of [2, 3, 4, 5, 6, 7]">
            <span class="legend-color" [style.background-color]="getOctaveColor(octave)"></span>
            <span class="legend-text">
              {{ getCurrentLanguage() === 'ru' ? '–û–∫—Ç–∞–≤–∞' : 'Octave' }} {{ octave }}
            </span>
          </div>
        </div>

        <div class="fretboard-container">
          <div class="fretboard-grid">
            <!-- –ó–∞–≥–æ–ª–æ–≤–æ–∫ —Å –Ω–æ–º–µ—Ä–∞–º–∏ –ª–∞–¥–æ–≤ -->
            <div class="fret-header">
              <div class="string-label">{{ getCurrentLanguage() === 'ru' ? '–°—Ç—Ä—É–Ω–∞' : 'String' }}</div>
              <div class="fret-number" *ngFor="let fret of [0, 1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11, 12, 13, 14, 15, 16, 17, 18, 19, 20, 21, 22, 23, 24]">
                {{ fret }}
              </div>
            </div>

            <!-- –°—Ç—Ä—É–Ω—ã —Å –ª–∞–¥–∞–º–∏ -->
            <div class="string-row" *ngFor="let stringNum of [1, 2, 3, 4, 5, 6]">
              <div class="string-label">{{ stringNum }}</div>
              <div class="fret-cell"
                   *ngFor="let fret of [0, 1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11, 12, 13, 14, 15, 16, 17, 18, 19, 20, 21, 22, 23, 24]"
                   [style.background-color]="getOctaveColor(getOctaveForMidi([40, 45, 50, 55, 59, 64][stringNum - 1] + fret))"
                   [class.fret-marker]="[3, 5, 7, 9, 12, 15, 17, 19, 21, 24].includes(fret)">
                <span class="fret-octave">
                  {{ getOctaveForMidi([40, 45, 50, 55, 59, 64][stringNum - 1] + fret) }}
                </span>
              </div>
            </div>
          </div>
        </div>

        <div class="fretboard-info">
          <p>{{ getCurrentLanguage() === 'ru'
            ? '–°—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã–π —Å—Ç—Ä–æ–π: E-A-D-G-B-E (6-—è —Å—Ç—Ä—É–Ω–∞ ‚Üí 1-—è —Å—Ç—Ä—É–Ω–∞)'
            : 'Standard tuning: E-A-D-G-B-E (6th string ‚Üí 1st string)' }}</p>
          <p>{{ getCurrentLanguage() === 'ru'
            ? '–ö–∞–∂–¥–∞—è —è—á–µ–π–∫–∞ –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç –Ω–æ–º–µ—Ä –æ–∫—Ç–∞–≤—ã –¥–ª—è –¥–∞–Ω–Ω–æ–π –ø–æ–∑–∏—Ü–∏–∏ –Ω–∞ –≥—Ä–∏—Ñ–µ'
            : 'Each cell shows the octave number for that position on the fretboard' }}</p>
        </div>
      </div>

      <!-- –¢–∞–±–ª–∏—Ü–∞ —Å—Ç—É–ø–µ–Ω–µ–π –ª–∞–¥–∞ (–ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç—Å—è —Ç–æ–ª—å–∫–æ –≤ —Ä–µ–∂–∏–º–µ scale-degrees) -->
      <div class="scale-degrees-table" *ngIf="isScaleDegreesMode() && scaleDegrees.length > 0">
        <div class="table-header">
          <span class="table-title">{{ 'HEADER.SCALE_DEGREES' | translate }}</span>
          <div class="table-toggles">
            <label class="toggle-label">
              <input type="checkbox" [(ngModel)]="showScaleNotes">
              <span>{{ 'SCALE_DEGREES.NOTES' | translate }}</span>
            </label>
          </div>
        </div>
        <div class="degrees-grid-container">
          <!-- –°—Ç—Ä–æ–∫–∞ —Å –∫–æ—Ä–æ—Ç–∫–∏–º–∏ –æ–±–æ–∑–Ω–∞—á–µ–Ω–∏—è–º–∏ -->
          <div class="degrees-row row-short">
            <ng-container *ngFor="let degree of scaleDegrees">
              <div class="degree-cell cell-short">{{ degree.short }}</div>
              <div class="interval-spacer"></div>
            </ng-container>
          </div>

          <!-- –°—Ç—Ä–æ–∫–∞ —Å –∞–Ω–≥–ª–∏–π—Å–∫–∏–º–∏ –Ω–∞–∑–≤–∞–Ω–∏—è–º–∏ -->
          <div class="degrees-row row-english" *ngIf="getCurrentLanguage() === 'en'">
            <ng-container *ngFor="let degree of scaleDegrees">
              <div class="degree-cell cell-english">{{ degree.englishFull }}</div>
              <div class="interval-spacer"></div>
            </ng-container>
          </div>

          <!-- –°—Ç—Ä–æ–∫–∞ —Å —Ä—É—Å—Å–∫–∏–º–∏ –Ω–∞–∑–≤–∞–Ω–∏—è–º–∏ -->
          <div class="degrees-row row-russian" *ngIf="getCurrentLanguage() === 'ru'">
            <ng-container *ngFor="let degree of scaleDegrees">
              <div class="degree-cell cell-russian">{{ degree.russianFull }}</div>
              <div class="interval-spacer"></div>
            </ng-container>
          </div>

          <!-- –°—Ç—Ä–æ–∫–∞ —Å –Ω–æ—Ç–∞–º–∏ –≥–∞–º–º—ã (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ) -->
          <div class="degrees-row row-notes" *ngIf="showScaleNotes && scaleNotes.length > 0">
            <ng-container *ngFor="let note of scaleNotes">
              <div class="degree-cell cell-note">{{ note }}</div>
              <div class="interval-spacer"></div>
            </ng-container>
          </div>

          <!-- –°—Ç—Ä–æ–∫–∞ —Å –∏–Ω—Ç–µ—Ä–≤–∞–ª–∞–º–∏ (–ú–ï–ñ–î–£ —Å—Ç—É–ø–µ–Ω—è–º–∏) -->
          <div class="degrees-row row-intervals">
            <ng-container *ngFor="let degree of scaleDegrees; let i = index">
              <div class="interval-placeholder"></div>
              <div class="interval-cell">
                <span class="interval-label">{{ getCurrentLanguage() === 'ru' ? (degree.interval === 'T' ? '–¢–æ–Ω' : '–ü–æ–ª—É—Ç–æ–Ω') : degree.intervalEnglish }}</span>
              </div>
            </ng-container>
          </div>
        </div>
      </div>
    </div>
  </header>

  <!-- –ü–∞–Ω–µ–ª—å —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è -->
  <app-player-controls
    [onOpenSettings]="openSettings.bind(this)">
  </app-player-controls>

  <!-- –û–±–ª–∞—Å—Ç—å –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è —Ç–∞–±—É–ª–∞—Ç—É—Ä—ã -->
  <div class="tablature-container">
    <div #alphaTab class="alphatab-viewport"></div>
  </div>

  <!-- –ü–∞–Ω–µ–ª—å –Ω–∞—Å—Ç—Ä–æ–µ–∫ -->
  <app-settings-panel #settingsPanel></app-settings-panel>

  <router-outlet />
</div>
